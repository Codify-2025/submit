# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: CI/CD for submit in k8s

# 1. ì‹¤í–‰ ì¡°ê±´: deploy-k8s ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí–ˆì„ ë•Œë§Œ ì‹¤í–‰
on:
  push:
    branches: [ "deploy-k8s" ]

# ì›Œí¬í”Œë¡œìš° ì „ì²´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.docker_build.outputs.image_tag }}
    env:
      TAG: ${{ github.run_id }} 
    permissions:
      contents: read
      packages: write # Docker ì´ë¯¸ì§€ í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”

    steps:
      - name: 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 2. JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ë¹Œë“œ
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test
      - name: 4. Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DEPLOY_USERNAME }}
          password: ${{ secrets.DEPLOY_PASSWORD }}

      - name: 5. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: docker_build
        run: |
          IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
          echo "Building and pushing image: ${{ env.IMAGE_NAME }}:$IMAGE_TAG"
          docker build -t ${{ secrets.DEPLOY_USERNAME }}/codify-submit:${{ env.TAG }} .
          docker push ${{ secrets.DEPLOY_USERNAME }}/codify-submit:${{ env.TAG }}
          echo "image_tag=${{ env.TAG }}" >> $GITHUB_OUTPUT
  # ============================================
  # CD íŠ¸ë¦¬ê±° Job (ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸)
  # ============================================
  
  deploy:
    # 'build-and-push' jobì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë¨
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: 1. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          repository: Codify-2025/k8s-manifests
          token: ${{ secrets.DEPLOY_PAT_TOKEN }}

      - name: 2. Deployment.yaml íŒŒì¼ì˜ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        working-directory: ./deploy/submit
        run: |
          sed -i "s|image: ${{ secrets.DEPLOY_USERNAME }}/codify-submit:.*|image: ${{ secrets.DEPLOY_USERNAME }}/codify-submit:${{ needs.build-and-push.outputs.image_tag }}|" deployment.yaml
      - name: 3. ë³€ê²½ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config --global user.name 'dylee00'
          git config --global user.email 'dylee6820@gmail.com'
          git add .
          if git diff-index --quiet HEAD; then
            echo "No changes to commit."
          else
            git commit -m "Deploy: Update submit image to ${{ needs.build-and-push.outputs.image_tag }}"
            git push
          fi
      - name: 4. Discord Notification
        if: steps.commit_step.outputs.deployed == 'true'
        uses: Ilshidur/action-discord@0.3.2
        env: 
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_USERNAME: DEPLOY_BOT
          DISCORD_AVATAR: https://github.com/pknu-wap/WAPP/blob/main/image/icon.png?raw=true
          DISCORD_EMBEDS: |  
            [
                  { 
                    "title": "ğŸš€ ë°°í¬ ì™„ë£Œ!",
                    "color": 65280,
                    "description": "${{ github.event.repository.name }} ì„œë¹„ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.",
                    "fields": [
                      {
                        "name": "Repository",
                        "value": "${{ github.event.repository.name }}",
                        "inline": true
                      },
                      {
                        "name": "Image Tag",
                        "value": "${{ needs.build-and-push.outputs.image_tag }}",
                        "inline": true
                      },
                      {
                        "name": "Actor",
                        "value": "${{ github.actor }}",
                        "inline": true
                      },
                      {
                        "name": "Commit",
                        "value": "[${{ github.sha }}](${{ github.event.repository.html_url }}/commit/${{ github.sha }})",
                        "inline": false
                      }
                    ],
                    "timestamp": "${{ github.event.head_commit.timestamp }}"
                  }
                ]
